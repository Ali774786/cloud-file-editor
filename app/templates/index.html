{% extends 'base.html' %} {% block title %}Data Viewer{% endblock %} {% block content %}
<div class="row mb-3">
  <div class="col-md-6">
    <h1>Data Viewer</h1>
  </div>
  <div class="col-md-6">
    <form method="GET" action="{{ url_for('api.index') }}" class="d-flex">
      <input
        type="text"
        name="search"
        class="form-control me-2"
        placeholder="Search data..."
        value="{{ search or '' }}"
      />
      <button type="submit" class="btn btn-outline-primary">Search</button>
    </form>
  </div>
</div>

{% if records %}
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>ID</th>
        {% for column in columns %}
        <th>{{ column_display_names[column] }}</th>
        {% endfor %}
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for record in records %}
      <tr data-id="{{ record.id }}">
        <td>{{ record.id }}</td>
        {% for column in columns %} {% if column != 'id' %}
        <td class="editable-cell" data-column="{{ column }}">
          {% if column in ['created_at', 'updated_at'] and getattr(record, column) %} {{ getattr(record,
          column).strftime('%Y-%m-%d %H:%M:%S') }} {% else %} {{ getattr(record, column, '') }} {% endif %}
        </td>
        {% else %}
        <td>{{ getattr(record, column, '') }}</td>
        {% endif %} {% endfor %}
        <td>
          <button class="btn btn-sm btn-primary save-btn" style="display: none">Save</button>
          <button class="btn btn-sm btn-secondary cancel-btn" style="display: none">Cancel</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if pagination.has_prev %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('api.index', page=pagination.prev_num, search=search) }}"
        aria-label="Previous"
      >
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% endif %} {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
    {% if page_num %} {% if page_num == pagination.page %}
    <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
    {% else %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('api.index', page=page_num, search=search) }}">{{ page_num }}</a>
    </li>
    {% endif %} {% else %}
    <li class="page-item disabled"><a class="page-link" href="#">â€¦</a></li>
    {% endif %} {% endfor %} {% if pagination.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('api.index', page=pagination.next_num, search=search) }}" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
    {% endif %}
  </ul>
</nav>
{% else %}
<div class="alert alert-info">
  No data available. <a href="{{ url_for('api.upload_file') }}">Upload a file</a> to get started.
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    let originalData = {};

    // Make cells editable on click
    $(".editable-cell").on("click", function () {
      const cell = $(this);
      const row = cell.closest("tr");
      const recordId = row.data("id");
      const column = cell.data("column");
      const currentValue = cell.text();

      // Store original data for potential cancellation
      if (!originalData[recordId]) {
        originalData[recordId] = {};
      }
      originalData[recordId][column] = currentValue;

      // Create an input field
      const input = $("<input>").attr("type", "text").addClass("form-control").val(currentValue);

      // Replace the cell content with the input
      cell.html(input).addClass("edit-mode");
      input.focus();

      // Show the save and cancel buttons
      row.find(".save-btn, .cancel-btn").show();
    });

    // Cancel button functionality
    $(".cancel-btn").on("click", function () {
      const row = $(this).closest("tr");
      const recordId = row.data("id");

      // Restore original values
      row.find(".editable-cell").each(function () {
        const cell = $(this);
        const column = cell.data("column");

        if (originalData[recordId] && originalData[recordId][column]) {
          cell.text(originalData[recordId][column]).removeClass("edit-mode");
        }
      });

      // Hide buttons
      row.find(".save-btn, .cancel-btn").hide();
    });

    // Save button functionality
    $(".save-btn").on("click", function () {
      const row = $(this).closest("tr");
      const recordId = row.data("id");
      const updatedData = {};

      // Collect values from all inputs
      row.find(".editable-cell").each(function () {
        const cell = $(this);
        const column = cell.data("column");
        const input = cell.find("input");

        if (input.length) {
          updatedData[column] = input.val();
        } else {
          updatedData[column] = cell.text();
        }
      });

      // Send AJAX request to update the data
      $.ajax({
        url: "/api/update/" + recordId,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(updatedData),
        success: function (response) {
          if (response.success) {
            // Update the cells with the saved values
            row.find(".editable-cell").each(function () {
              const cell = $(this);
              const column = cell.data("column");
              cell.text(updatedData[column]).removeClass("edit-mode");
            });

            // Hide buttons
            row.find(".save-btn, .cancel-btn").hide();

            // Optional: Show success message
            alert("Changes saved successfully");
          } else {
            alert("Error: " + response.message);
          }
        },
        error: function (xhr) {
          let errorMessage = "An error occurred while saving changes.";
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          alert("Error: " + errorMessage);
        },
      });
    });
  });
</script>
{% endblock %}
